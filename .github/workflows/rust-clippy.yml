name: rust-clippy analyze

on:
  push:
    paths:
      - 'proto/**'
      - 'src-tauri/**'
  schedule:
    - cron: '41 12 * * 0'

jobs:
  rust-clippy-analyze:
    name: Run rust-clippy analyzing
    runs-on: ubuntu-20.04
    defaults:
      run:
        working-directory: src-tauri
    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: Install linux deps
        uses: awalsh128/cache-apt-pkgs-action@latest
        with:
          packages: libgtk-3-dev webkit2gtk-4.0 libappindicator3-dev librsvg2-dev patchelf
          version: 1.0

      - name: Setup protoc
        uses: arduino/setup-protoc@v1
        with:
          version: '3.x'

      - uses: actions/setup-go@v3
        with:
          go-version: '>=1.17.0'

      - name: Build scraper binary
        working-directory: scraper
        run: make build dist=../dist/api

      - name: Install Rust toolchain
        uses: actions-rs/toolchain@16499b5e05bf2e26879000db0c1d13f7e13fa3af #@v1
        with:
          profile: minimal
          toolchain: stable
          components: clippy
          override: true

      - uses: actions-rs/clippy-check@v1
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          args: --all-features --manifest-path src-tauri/Cargo.toml
